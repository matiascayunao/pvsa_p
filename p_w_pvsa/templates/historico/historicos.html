{% extends "base.html" %}
{% block content %}
<div class="container py-4">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <div>
      <h2 class="mb-0">Históricos</h2>
      <div class="text-muted">Cambios registrados en los objetos del lugar</div>
    </div>
  </div>

  <div class="row">
    <!-- Panel de filtros -->
    <div class="col-md-3 mb-3">
      <div class="card shadow-sm border-0">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span class="fw-semibold">Filtros</span>
          <!-- Ajusta el nombre de la vista si tu URL se llama distinto -->
          <a href="{% url 'lista_historicos' %}" class="small text-decoration-none">Borrar filtros</a>
        </div>
        <div class="card-body">
          <form method="get" class="vstack gap-3">
            <!-- Lugar -->
            <div>
              <label for="id_filtro_lugar" class="form-label mb-1">Lugar</label>
              <select
                id="id_filtro_lugar"
                name="lugar"
                class="form-select form-select-sm"
              >
                <option value="">Todos los lugares</option>
                {% for l in lugares %}
                  <option value="{{ l.id }}"
                          {% if lugar_actual == l.id|stringformat:'s' %}selected{% endif %}>
                    {{ l.nombre_del_lugar }} – Piso {{ l.piso.piso }} – {{ l.piso.ubicacion }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Objeto -->
            <div>
              <label for="id_filtro_objeto" class="form-label mb-1">Objeto</label>
              <select
                id="id_filtro_objeto"
                name="objeto"
                class="form-select form-select-sm"
              >
                <option value="">Todos los objetos</option>
                {% for obj in objetos_catalogo %}
                  <option value="{{ obj.id }}"
                          {% if objeto_actual == obj.id|stringformat:'s' %}selected{% endif %}>
                    {{ obj.nombre_del_objeto }}
                    ({{ obj.objeto_categoria.nombre_de_categoria|default:obj.objeto_categoria }})
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Tipo de objeto -->
            <div>
              <label for="id_filtro_tipo" class="form-label mb-1">Tipo de objeto</label>
              <select
                id="id_filtro_tipo"
                name="tipo"
                class="form-select form-select-sm"
              >
                <option value="">Todos los tipos</option>
                {% for t in tipos %}
                  <option value="{{ t.id }}"
                          {% if tipo_actual == t.id|stringformat:'s' %}selected{% endif %}>
                    {{ t.objeto.nombre_del_objeto }} – {{ t.marca }} {{ t.material }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <!-- Estado anterior -->
            <div>
              <label for="id_filtro_estado" class="form-label mb-1">Estado anterior</label>
              <select
                id="id_filtro_estado"
                name="estado"
                class="form-select form-select-sm"
              >
                <option value="">Todos los estados</option>
                {% for value, label in estados %}
                  <option value="{{ value }}"
                          {% if estado_actual == value|stringformat:'s' %}selected{% endif %}>
                    {{ label }}
                  </option>
                {% endfor %}
              </select>
            </div>

            <button type="submit" class="btn btn-primary btn-sm mt-2 w-100">
              Aplicar filtros
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Tabla de resultados -->
    <div class="col-md-9">
      <div class="card shadow-sm border-0">
        <div class="card-body p-0">
          {% if historicos %}
            <div class="table-responsive">
              <table class="table align-middle mb-0">
                <thead class="table-light">
                  <tr>
                    <th>Lugar / Objeto</th>
                    <th>Cant. anterior</th>
                    <th>Estado anterior</th>
                    <th>Detalle anterior</th>
                    <th>Fecha</th>
                    <th class="text-end">Acciones</th>
                  </tr>
                </thead>
                <tbody>
                  {% for h in historicos %}
                  <tr>
                    <!-- Lugar + Objeto -->
                    <td>
                      <div class="fw-semibold">
                        {{ h.objeto_del_lugar.lugar.nombre_del_lugar }}
                      </div>
                      <div class="text-muted small">
                        Piso {{ h.objeto_del_lugar.lugar.piso.piso }} ·
                        {{ h.objeto_del_lugar.lugar.piso.ubicacion }} ·
                        {{ h.objeto_del_lugar.lugar.piso.ubicacion.sector }}
                      </div>
                      <div class="small mt-1">
                        Objeto: {{ h.objeto_del_lugar.tipo_de_objeto.objeto.nombre_del_objeto }}
                        · Categoría: {{ h.objeto_del_lugar.tipo_de_objeto.objeto.objeto_categoria.nombre_de_categoria }}
                      </div>
                      <div class="text-muted small">
                        Tipo: {{ h.objeto_del_lugar.tipo_de_objeto.marca }}
                        {{ h.objeto_del_lugar.tipo_de_objeto.material }}
                      </div>
                    </td>

                    <!-- Cantidad anterior -->
                    <td class="text-center">{{ h.cantidad_anterior }}</td>

                    <!-- Estado anterior -->
                    <td>{{ h.get_estado_anterior_display }}</td>

                    <!-- Detalle anterior -->
                    <td class="text-muted">
                      {% if h.detalle_anterior %}
                        {{ h.detalle_anterior }}
                      {% else %}
                        -
                      {% endif %}
                    </td>

                    <!-- Fecha anterior -->
                    <td>{{ h.fecha_anterior|date:"d \d\e F \d\e Y" }}</td>


                    <!-- Acciones -->
                    <td class="text-end">
                      <a class="btn btn-outline-primary btn-sm"
                         href="{% url 'detalle_historico' historico_id=h.id %}">Ver</a>
                      <a class="btn btn-outline-secondary btn-sm"
                         href="{% url 'editar_historico' historico_id=h.id %}">Editar</a>
                      <a class="btn btn-outline-danger btn-sm"
                         href="{% url 'borrar_historico' historico_id=h.id %}">Borrar</a>
                    </td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="p-4">
              <div class="alert alert-secondary mb-0">
                No hay históricos registrados
                {% if lugar_actual or objeto_actual or tipo_actual or estado_actual %}
                  para el filtro seleccionado
                {% endif %}.
              </div>
            </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}